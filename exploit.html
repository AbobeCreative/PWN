<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Webhook Fetch</title>
</head>
<body>
  <h1>Страница с запросом на вебхук</h1>
  <p>При заходе на страницу отправляется POST-запрос. При уходе — beacon.</p>

  <script>
    const WEBHOOK_URL = "https://webhook.site/fe173d82-05d7-4100-b4ae-ea80dddc7f43";

    // Отправка при заходе (page load)
    async function sendOnLoad() {
      try {
        const payload = {
          event: "page_load",
          url: window.location.href,
          referrer: document.referrer || null,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent
        };

        const res = await fetch(WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload),
          // Можно добавить "mode: 'no-cors'" если нужны только срабатывания,
          // но тогда ответ и ошибки будут недоступны.
          // mode: "no-cors"
        });

        // Необязательная обработка ответа
        // console.log("Status:", res.status);
      } catch (err) {
        // console.error("Ошибка отправки на вебхук:", err);
      }
    }

    // Надёжная отправка перед уходом со страницы
    function sendOnLeave() {
      const payload = {
        event: "page_leave",
        url: window.location.href,
        timestamp: new Date().toISOString()
      };
      const data = JSON.stringify(payload);
      // sendBeacon не блокирует переход, лучше подходит для beforeunload
      navigator.sendBeacon(WEBHOOK_URL, data);
    }

    // Инициализация
    window.addEventListener("DOMContentLoaded", sendOnLoad);
    window.addEventListener("beforeunload", sendOnLeave);
  </script>
</body>
</html>
